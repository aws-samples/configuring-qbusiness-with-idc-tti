# Sample web application to demonstrate Trusted Token Propagation with AWS IAM Identity Center

You can use this sample web application to demonstrate how Trusted Token Propagation Authorization Flow works with AWS IAM Identity Center.

## Getting started
1. Review [Configuring Amazon Q Business with AWS IAM Identity Center trusted identity propagation](../docs/tutorials/idc/intro-idc-tti.md)
2. Depending on the choice of your identity provider follow one of the end-to-end tutorials:
    * _**Okta:**_ [Configuring sample web application with Okta](../docs/tutorials/okta/config-webapp-using-okta.md)
    * _**Microsoft Entra:**_ [Configuring sample web application with Microsoft Entra](../docs/tutorials/entra/config-webapp-using-entra.md)

## Registering sample web application with OIDC compliant identity provider
Use these callback and logout URLs when registering the sample application with an OIDC compliant identity provider (Okta, Microsoft Entra, or Amazon Cognito). When running from your workstation, the sample web application defaults to using `localhost` as the domain name and `8080` as the port.
* **Callback URL:** `http://<domain_name>:<port>/authorization-code/callback`
* **Logout URL (Optional):** `http://<domain_name>:<port>/logout`

### Trusted Token Issuer URI, Audience ID, Client ID and Client Secret
When registering your web application with an OIDC compliant identity provider, the provider generates a `Client ID`, `Client Secret` and `Audience ID`. You need these to identify your application to the provider when requesting ID tokens. For most identity providers, the `Client ID` is used as the `Audience ID` by default unless specified otherwise.

Identity providers host an authorization server and offer a `Token Issuer URI` for applications to authorize users and obtain ID tokens. Below are the default `Token Issuer URI` for some common identity providers and instructions on how to find them.

#### Trusted token issuer URI syntax by identity provider
* _**Okta:**_ `https://<okta_domain>/oauth2/default`
    * For details see [How to find Okta Issuer URI](../docs/tutorials/okta/find-okta-issuer-url.md)
* _**Microsoft Entra:**_ `https://login.microsoftonline.com/<tenant-id>/v2.0`
    * For details see [How to find Microsoft Entra Issuer URI](../docs/tutorials/entra/find-entra-issuer-url.md) 
* _**Amazon Cognito:**_ `https://cognito-idp.<aws_region>.amazonaws.com/<cognito_user_pool_id>`

## Configure web application environment variables
The required environment variables for the sample web application are configured via a `.env` file stored in the `<project_home>/webapp/config/` folder. A template of the `.env` file for commonly used identity providers is available in this folder for reference. Rename the template file `.env.<identity_provider>.dist` to `.env` and update the attribute values as needed. For more details on obtaining values for these attributes, see one of the [end-to-end tutorials](../docs/README.md). A brief description of the attributes is provided below.

```
# OAuth client configuration
# Validate issuer url using '<issuer_url>/.well-known/openid-configuration'
issuer_url=<Trusted Token Issuer URI>
client_id=<OIDC client ID>
client_secret=<OIDC client secret>

# Application configuration
idc_provider_apl_arn=arn:aws:sso::<idc_acc_id>:application/ssoins-<idc_instance_id>/apl-<idc_provider_application_id>
qb_sts_role=arn:aws:iam::<app_acc_id>:role/<role_name>
qb_apl_id=<qbusiness_application_id>
app_domain=<hostname>:<port>
region_name=<aws_region_name>
```

The `.env` environment file has two sections: OAuth client and application configuration. The environment values for the OAuth client section are obtained by registering the sample web application with your identity provider. The environment values for the application configuration section are obtained from your Q Business, IAM user, and Identity Center setup in your AWS account.
#### OAuth Client Configuration:
* **issuer_url:** The _issuer_url_ is the primary URL hosted by OIDC Identity Provider to facilitate discovery, and authorization and identity token generation. Refer to `Registering sample web application with OIDC compliant identity provider` section for examples of issuer_url for your IdP provider.
* **client_id:** The _client_id_ is a public identifier for apps. A unique ID is generated by your IdP when creating n OIDC Web App.
* **client_secret:** The _client_secret_ is a secret known only to the application and the authorization server. The secret is generated by your IdP when creating n OIDC Web App.

#### Application Configuration:
* **idc_provider_apl_arn:** ARN for IAM Identity Center custom application auth provider. This is the output of _CloudFormation template for configuring AWS IAM Identity Center_. For more information see [CFN README](../cf/README.md)
* **qb_sts_role:** ARN of IAM Role used by STS `AssumeRole` API. This is the output of _CloudFormation template for configuring your application_. For more information see [CFN README](../cf/README.md)
* **qb_apl_id:** Amazon Q Business application id
* **app_domain:** Hostname and port of the domain where this sample web application is hosted. If running locally use `localhost:8080`
* **region_name:** AWS region name where your Amazon Q Business application is deployed. Example `us-east-1` or `us-west-2`.
